# Имя ресурсов в кластере (StatefulSet, Pod, Service и т.д.) 
# Окружение lab.local (K3s). Можно переопределить, например: vault-lab-local
fullnameOverride: vault
global:
  enabled: true
  serverTelemetry:
    prometheusOperator: false   # без Prometheus Operator в кластере — ServiceMonitor не создаём
  tlsDisable: false
  # K3s: PSP deprecated, используем Pod Security Standards
  psp:
    enable: false
injector:
  image:
    repository: "hashicorp/vault-k8s"
    tag: "1.2.1"
  agentImage:
    repository: "hashicorp/vault"
    tag: 1.14.0
  certs:
    # CA bundle из preconfigure/keys/lab.local/caBundle.b64 (сгенерировано generate-vault-certs.sh)
    caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUZZekNDQTB1Z0F3SUJBZ0lVWmpyTEtOa2pQZEhBcVl0TTVHNURvUE5TUU1vd0RRWUpLb1pJaHZjTkFRRUwKQlFBd1FURVNNQkFHQTFVRUNnd0piR0ZpTG14dlkyRnNNUTR3REFZRFZRUUxEQVYyWVhWc2RERWJNQmtHQTFVRQpBd3dTYkdGaUxteHZZMkZzSUZaaGRXeDBJRU5CTUI0WERUSTJNREl5T0RBeE1EazBNRm9YRFRNMk1ESXlOakF4Ck1EazBNRm93UVRFU01CQUdBMVVFQ2d3SmJHRmlMbXh2WTJGc01RNHdEQVlEVlFRTERBVjJZWFZzZERFYk1Ca0cKQTFVRUF3d1NiR0ZpTG14dlkyRnNJRlpoZFd4MElFTkJNSUlDSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQWc4QQpNSUlDQ2dLQ0FnRUFqT2ZRSUMrZkRBNU03RFN6S0ZzMyszTmhOYkg3V2VFY2t3NE5RM3puWUI3NjRqcjBFNncxClBTUU1RQWoyak4zeUFSOHlSN2g5aUNDK0ZnZld6ZmYxMHNYL3BFdlFnYlVVV2ZnNkgvcm1OdmkydzlSRlNxaUwKcE9SdS9NN0dVU2VoQXpwdzlXQ0U2M3hVQmFHRFY1aWhpYlpGUEJCVGgzMzRyYXZhS3hUb25rM2dkR1FtUEFGcApsaWRUaW4xKzFCMUxGbTd2T2pBY0ZOd3Vsd2lsTldRejFXblFEbDRhdWZQaDZWSkdkblk0TUQvc3B3TGc5QjhCCk9MM3AweExBQjZKUXpOV0dyMnI0NHhwZlZZc2NUbmpnMUJsQW53TFcrTG1NMXFVYXk0alQ2ZVpHLzNqVHVBdGEKdHJVeEVGYXZXRnJVUHFHWWxFTnZndUgvVTFSaTA0eVlzQVViaGZ4V0paZldlSHFsSTVPNFFwcElVcTZnZmNRaAozdVBONjUxMC9qV1NqT0tZUEVpM2tuUlhBekJvSDMxdlhiRVp3QjR0TUVoVWJhdFR4Qllxb0hUYVM5R0NVWlV6CjFwTk56Yy9CdXgvL1g2Z0ppWEpTOVBiYTVzVnlndVp6SWNwekQ3OEN4cFcrb0tiV0hxMkRwKzM1d2MvSERPYzAKeGRjeldYVno5MkQ4eGZQU0pnWDllVFZCSFNObHU2RXJXcURJYWNtSG1paXU0WUdBdmphTUFkV29XaFRwa1FzOQphRUozeGJ4NmhXWlM2SmY2SGpBRzBpVkRuYTdXNld6RkxnUU50bGQxclgwYXZJMEIreWpENlVNS2RnS3poWHBNCmpVeWRiY3FrSmN0SGtRcHd5TTlLelg3VjcwelMrUXdDcy9wVS9KeTZubTBsTFZGeUtSdU4xQU1DQXdFQUFhTlQKTUZFd0hRWURWUjBPQkJZRUZIa0RSM09iZ0ZTWkIxVlZWZVNrdGovcFlpNW9NQjhHQTFVZEl3UVlNQmFBRkhrRApSM09iZ0ZTWkIxVlZWZVNrdGovcFlpNW9NQThHQTFVZEV3RUIvd1FGTUFNQkFmOHdEUVlKS29aSWh2Y05BUUVMCkJRQURnZ0lCQUJ1a0lWNXM0U1BVMzFsNG14UzEwRTFwV1JiK1pVeFhvRTFISDhOWmxmQ3VFUjdFK3UzazJaeDEKN09Md2xseTUxZG55R21pQlpzaXU0dGNoMm1seWk3UCt5QTVoVUgyZEh5MTc3ZkpBeFJvdElWejJVczRRTG9TQQpFZGFSU3B6SGNiTXU3R3d1ajJyb3lUd1ZGRXBiYzNjUlhaSUtBbktXL25LamNKeExyd1N6bldnS0hhbjBaRTd0CmhFcm14M1NhY3orN29qTFFObDFxZk10NlZLTUFibXZST0VsZ2JHZUljRXk0TkgyMVFPN3phZVlTdXNsZHZXUEYKc0tibHNEWGpDVlE4Q20veWdhRnJQeGsvaEpKUTVYSEVCU2F3NVU2M09RN05uWmg4Y2tKbXA0TzlIODFpVDN4SAp0YVRvS2QyY1Q0YzNRblcvRnNBL3BZeFg1K1d6cElHRjREeW1LbnFVSEZLOTFMclVSZWtIV0p6cGxCeUV2cnFVCldtSUlkTTlxdjRYclZCVkNJMWZMeWNnaG03ZnZwSjZXYjVlWElTUHpMRXgvWkQ5dlFCZnpkdGUzVUFzSjEwVjUKU0lTVlJsbVA0dEJwT05qbmdvR2EvbXFLSWpJU2kybGZRVk4xUnhtbVMwWFdzY3pBZ3RYVzRCVW5yb0RPMGpMcQpJWkdkMUNpUThyalNvYnFWTlR0a1pBR3JkSGFiVHpZbFdGKzJwTVZzVW12cUt5Q1JwUCtXSXN0WVdtQklGVmI0CjVpN1ZnNDVuK0Rwb2U5OW1hTG40bU1hU0szN1dTNjRLcStMZGRRbkxKU2N3Z0FCSnJpem85c3hCcnR6OSttWGQKQ04wL0JhMW1ybXJXaHdWSnBTcE1hS2d0N1hnUW9jUTRCTXIxMXdabEpKcFlzTkwrMG03TQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
    secretName: vault-injector-crt
  enabled: true
  resources:
    limits:
      cpu: 260m
      memory: 256Mi
    requests:
      cpu: 260m
      memory: 256Mi
server:
  auditStorage:
    enabled: true
    mountPath: /vault/audit
    size: 10Gi
    # K3s: стандартный provisioner — local-path
    storageClass: local-path
  dataStorage:
    enabled: true
    mountPath: /vault/data
    size: 10Gi
    storageClass: local-path
  enabled: true
  extraEnvironmentVars:
    VAULT_CACERT: /vault/userconfig/vault-ca/ca.crt
  extraVolumes:
    - name: vault-ca
      type: configMap
    - name: vault-crt
      type: secret
  ha:
    apiAddr: "https://$(VAULT_K8S_POD_NAME).vault-internal:8200"
    enabled: true
    raft:
      config: >
        ui = true
        disable_mlock = true
        listener "tcp" {
          tls_disable = false
          address = "[::]:8200"
          cluster_address = "[::]:8201"
          tls_cert_file = "/vault/userconfig/vault-crt/tls.crt"
          tls_key_file = "/vault/userconfig/vault-crt/tls.key"
          tls_client_ca_file = "/vault/userconfig/vault-ca/ca.crt"
          # Enable unauthenticated metrics access (necessary for Prometheus Operator)
          telemetry {
            unauthenticated_metrics_access = "true"
          }
        }
        telemetry {
          prometheus_retention_time = "30s"
          disable_hostname = true
        }
        storage "raft" {
          path = "/vault/data"
          retry_join {
            leader_api_addr = "https://vault-0.vault-internal:8200"
            leader_ca_cert_file = "/vault/userconfig/vault-ca/ca.crt"
            leader_client_cert_file = "/vault/userconfig/vault-crt/tls.crt"
            leader_client_key_file = "/vault/userconfig/vault-crt/tls.key"
          }
        }
        service_registration "kubernetes" {}
      enabled: true
      setNodeId: true
    replicas: 1
  image:
    repository: "hashicorp/vault"
    tag: 1.14.0
  ingress:
    activeService: true
    annotations:
      cert-manager.io/cluster-issuer: "selfsigned-issuer"
      # K3s: Traefik — entrypoint для TLS
      traefik.ingress.kubernetes.io/router.entrypoints: websecure
    enabled: true
    ingressClassName: traefik
    hosts:
      - host: vault.lab.local
        paths: []
    # TLS для Ingress (cert-manager)
    tls:
      - secretName: vault-ingress-tls
        hosts:
          - vault.lab.local
  livenessProbe:
    enabled: true
    initialDelaySeconds: 60
    path: /v1/sys/health?standbyok=true
    port: 8200
    timeoutSeconds: 10
    periodSeconds: 10
    failureThreshold: 3
  readinessProbe:
    enabled: true
    path: /v1/sys/health?standbyok=true&sealedcode=204&uninitcode=204
    port: 8200
    timeoutSeconds: 10
    periodSeconds: 5
    initialDelaySeconds: 10
    failureThreshold: 5
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 256Mi
  updateStrategyType: OnDelete
  # K3s/Traefik: backend HTTPS к Vault (порт 8200). ServersTransport отключает проверку сертификата бэкенда.
  # Применить serverstransport.yaml: kubectl apply -f argocd-apps/vault/serverstransport.yaml
  service:
    annotations:
      traefik.ingress.kubernetes.io/service.serversscheme: https
      traefik.ingress.kubernetes.io/service.serverstransport: vault-vault-insecure@kubernetescrd
serverTelemetry:
  prometheusRules:
    enabled: false
  serviceMonitor:
    enabled: false
ui:
  enabled: true
  externalPort: 8200
  serviceNodePort: null
  serviceType: ClusterIP

csi:
  image:
    repository: "hashicorp/vault-csi-provider"
    tag: "1.4.0"
